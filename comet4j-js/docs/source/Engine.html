<html>
<head>
  <title>The source code</title>
    <link href="../resources/prettify/prettify.css" type="text/css" rel="stylesheet" />
    <script type="text/javascript" src="../resources/prettify/prettify.js"></script>
</head>
<body  onload="prettyPrint();">
    <pre class="prettyprint lang-js">/*
 * Comet4J JavaScript Client V0.1.7
 * Copyright(c) 2011, jinghai.xiao@gamil.com.
 * http://code.google.com/p/comet4j/
 * This code is licensed under BSD license. Use it as you wish, 
 * but keep this copyright intact.
 */

<div id="cls-JS.Engine"></div>/**
 * æ¶ˆæ¯å¼•æ“,
 * è´Ÿè´£å°†æœåŠ¡å™¨æ¨é?çš„é?é“æ•°æ®ï¼Œä»¥äº‹ä»¶çš„æ–¹å¼è§¦å‘ï¼Œäº‹ä»¶åç§°ä¸é€šé“åç§°ç›¸åŒã€?
 * @class JS.Engine
 * @singleton 
 * @extends JS.Observable
 * @author jinghai.xiao@gmail.com
 */
JS.ns("JS.Engine");
JS.Engine = (function(){
	var Engine = JS.extend(JS.Observable,{
		lStore : [],//ç”¨äºå­˜æ”¾æ²¡å¯åŠ¨çŠ¶æ€ä¸‹ç”¨æˆ·å¢åŠ çš„ä¾¦å?
		<div id="prop-JS.Engine-running"></div>/** 
		 * å¼•æ“æ˜¯å¦å¤„äºå·¥ä½œçŠ¶æ?
		 * @property 
		 * @type Boolean
		 */ 
		running : false,
		<div id="prop-JS.Engine-connector"></div>/** 
		 * å¼•æ“æ‰?½¿ç”¨çš„è¿æ¥å™?
		 * @property 
		 * @type JS.Connector
		 */ 
		connector : null,
		constructor:function(){
			this.addEvents([
				<div id="event-JS.Engine-start"></div>/**
				 * @event start å¼?§‹äº‹ä»¶
				 * @param {String} cId è¿æ¥ID
				 * @param {Array<String>} channels é€šé“åˆ—è¡¨
				 * @param {JS.Engine} engine äº‹ä»¶å¼•æ“
				 */   
				'start',
				<div id="event-JS.Engine-stop"></div>/*** 
				 * @event stop åœæ­¢äº‹ä»¶
				 * @param {String} cause åœæ­¢åŸå› 
				 * @param {String} cId è¿æ¥ID
				 * @param {String} url è¿æ¥åœ°å€
				 * @param {JS.Engine} engine äº‹ä»¶å¼•æ“
				 */
				'stop'
			]);
			Engine.superclass.constructor.apply(this,arguments);
			this.connector = new JS.Connector();
			this.initEvent();
		},
		<div id="method-JS.Engine-on"></div>/**
		 * æ³¨å†Œé€šé“ä¾¦å¬
		 * @method on
		 * @param {String | Map<String,Function>} channelName é€šé“åç§°æˆ–å¤šä¸ªé?é“åç§°å’Œä¾¦å¬å‡½æ•°çš„é”®å€¼å¯¹
		 * @param {Function} fn ä¾¦å¬å‡½æ•°
		 * @param {Object} scope ä¾¦å¬å‡½æ•°ä½œç”¨åŸ?
		 */
		//é‡è½½addListenerå‡½æ•°
		addListener : function(eventName, fn, scope, o){
			if(this.running){
				Engine.superclass.addListener.apply(this,arguments);
			}else{
				this.lStore.push({
					eventName : eventName,
					fn : fn,
					scope : scope,
					o : o
				});
			}
		},
		//private 
		initEvent : function(){
			var self = this;
			this.connector.on({
				connect : function(cId, aml, conn){
					//self.running = true;
					self.addEvents(aml);
					for(var i=0,len=self.lStore.length; i<len; i++){
						var e = self.lStore[i];
						self.addListener(e.eventName,e.fn,e.scope);
					}
					self.fireEvent('start', cId, aml, self);
				},
				stop : function(cause, cId, url, conn){
					self.running = false;
					self.fireEvent('stop',cause, cId,url, self);
					self.clearListeners();
				},
				message : function(amk, data, time){
					self.fireEvent(amk, data, time, self);
				}
			});
		},
		<div id="method-JS.Engine-start"></div>/**
		 * å¼?§‹è¿æ¥
		 * @method 
		 * @param {String} url è¿æ¥åœ°å€
		 * @param {String} param è¿æ¥å‚æ•°
		 */
		start : function(url,param){
			this.running = true;
			/*
			if(this.running){
				return;
			}*/
			for(var i=0,len=this.lStore.length; i<len; i++){
				var e = this.lStore[i];
				this.addListener(e.eventName,e.fn,e.scope);
			}
			this.connector.start(url,param);
		},
		<div id="method-JS.Engine-stop"></div>/**
		 * åœæ­¢è¿æ¥
		 * @method 
		 * @param {String} cause åœæ­¢åŸå› 
		 */
		stop : function(cause){
			if(!this.running){
				return;
			}
			this.connector.stop(cause);
		},
		<div id="method-JS.Engine-getConnector"></div>/**
		 * è·å¾—è¿æ¥å™¨å®ä¾?
		 * @method 
		 * @return {JS.Connector} connector è¿æ¥å™¨å®ä¾?
		 */
		getConnector : function(){
			return this.connector;
		},
		<div id="method-JS.Engine-getId"></div>/**
		 * è·å¾—è¿æ¥ID
		 * @method 
		 * @return {String} è¿æ¥ID
		 */
		getId : function(){
			return this.connector.cId;
		}
		
	});
	return new Engine();
}());</pre>    
</body>
</html>