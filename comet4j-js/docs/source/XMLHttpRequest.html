<html>
<head>
  <title>The source code</title>
    <link href="../resources/prettify/prettify.css" type="text/css" rel="stylesheet" />
    <script type="text/javascript" src="../resources/prettify/prettify.js"></script>
</head>
<body  onload="prettyPrint();">
    <pre class="prettyprint lang-js">/*
 * Comet4J JavaScript Client V0.1.7
 * Copyright(c) 2011, jinghai.xiao@gamil.com.
 * http://code.google.com/p/comet4j/
 * This code is licensed under BSD license. Use it as you wish, 
 * but keep this copyright intact.
 */

JS.ns("JS.HTTPStatus","JS.XMLHttpRequest");
<div id="prop-JS.Listener-HTTPStatus"></div>/**
 * FC 2616 HTTP1.1è§„èŒƒçš„HTTP StatusçŠ¶æ?å¸¸é‡,è¯¦è§
 * http://www.w3.org/Protocols/rfc2616/rfc2616-sec10.html#sec10
 * @author jinghai.xiao@gmail.com
 */
JS.HTTPStatus = {
	//Informational 1xx
	'100' : 'Continue',
	'101' : 'Switching Protocols',
	//Successful 2xx
	'200' : 'OK',
	'201' : 'Created',
	'202' : 'Accepted',
	'203' : 'Non-Authoritative Information',
	'204' : 'No Content',
	'205' : 'Reset Content',
	'206' : 'Partial Content',
	//Redirection 3xx
	'300' : 'Multiple Choices',
	'301' : 'Moved Permanently',
	'302' : 'Found',
	'303' : 'See Other',
	'304' : 'Not Modified',
	'305' : 'Use Proxy',
	'306' : 'Unused',
	'307' : 'Temporary Redirect',
	//Client Error 4xx
	'400' : 'Bad Request',
	'401' : 'Unauthorized',
	'402' : 'Payment Required',
	'403' : 'Forbidden',
	'404' : 'Not Found',
	'405' : 'Method Not Allowed',
	'406' : 'Not Acceptable',
	'407' : 'Proxy Authentication Required',
	'408' : 'Request Timeout',
	'409' : 'Conflict',
	'410' : 'Gone',
	'411' : 'Length Required',
	'412' : 'Precondition Failed',
	'413' : 'Request Entity Too Large',
	'414' : 'Request-URI Too Long',
	'415' : 'Unsupported Media Type',
	'416' : 'Requested Range Not Satisfiable',
	'417' : 'Expectation Failed',
	//Server Error 5xx
	'500' : 'Internal Server Error',
	'501' : 'Not Implemented',
	'502' : 'Bad Gateway',
	'503' : 'Service Unavailable',
	'504' : 'Gateway Timeout',
	'505' : 'HTTP Version Not Supported'
};
JS.HTTPStatus.OK = 200;
JS.HTTPStatus.BADREQUEST = 400;
JS.HTTPStatus.FORBIDDEN = 403;
JS.HTTPStatus.NOTFOUND = 404;
JS.HTTPStatus.TIMEOUT = 408;
JS.HTTPStatus.SERVERERROR = 500;

<div id="cls-JS.XMLHttpRequest"></div>/**
 * @class JS.XMLHttpRequest
 * @extends JS.Observable
 * è·¨æµè§ˆå™¨ã€äº‹ä»¶é©±åŠ¨çš„XMLHTTPRequestå¯¹è±¡ï¼Œæ­¤å¯¹è±¡å®Œå…¨å…¼å®¹ä¼ ç»ŸXMLHTTPRequestå¯¹è±¡ï¼Œåœ¨éµå¾ª
 * http://www.w3.org/TR/XMLHttpRequest/æ ‡å‡†çš„å‰æä¸‹æœ‰æ‰€æ‰©å±•ã€?
 * @author jinghai.xiao@gmail.com
 */
JS.XMLHttpRequest = JS.extend(JS.Observable,{
	<div id="cfg-JS.XMLHttpRequest-enableCache"></div>/**
	 * @cfg {Boolean} enableCache 
	 * æ˜¯å¦å¯ç”¨ç¼“å­˜ï¼Œé»˜è®¤ä¸ºfalse
	 */
	enableCache : false,
	<div id="cfg-JS.XMLHttpRequest-timeout"></div>/**
	 * @cfg {Number} timeout 
	 * è¯·æ±‚è¶…æ—¶æ¯«ç§’æ•°ï¼Œé»˜è®¤ä¸?0000(30ç§?ï¼Œè®¾ç½®ä¸º0åˆ™æ°¸ä¸è¶…æ—?
	 */
	timeout : 30000,//default never time out
	<div id="prop-JS.XMLHttpRequest-isAbort"></div>/** 
	 * æ˜¯å¦è°ƒç”¨äº†abortæ–¹æ³•
	 * @property 
	 * @type Boolean
	 */ 
	isAbort : false,
	<div id="cfg-JS.XMLHttpRequest-specialXHR"></div>/**
	 * @cfg {String} specialXHR 
	 * æŒ‡å®šä¸?¸ªç‰¹å®šçš„ActiveXå¯¹è±¡åç§°ç”¨äºå–ä»£XMLHTTPRequestå¯¹è±¡ï¼Œé»˜è®¤ä¸ºç©ºã?
	 */
	specialXHR : '',//æŒ‡å®šä½¿ç”¨ç‰¹æ®Šçš„xhrå¯¹è±¡
	//propoty
	_xhr : null,
	//--------request propoty--------
	<div id="prop-JS.XMLHttpRequest-readyState"></div>/** 
	 * @property 
	 * @type Number
	 */ 
	readyState : 0,
	//--------response propoty--------
	<div id="prop-JS.XMLHttpRequest-status"></div>/** 
	 * @property 
	 * @type Number
	 */ 
	status : 0,
	<div id="prop-JS.XMLHttpRequest-statusText"></div>/** 
	 * @property 
	 * @type String
	 */ 
	statusText : '',
	<div id="prop-JS.XMLHttpRequest-responseText"></div>/** 
	 * @property 
	 * @type String
	 */
	responseText : '',
	<div id="prop-JS.XMLHttpRequest-responseXML"></div>/** 
	 * @property 
	 * @type DOM
	 */
	responseXML : null,
	//private method
	constructor : function(){
		var self = this;
		this.addEvents([
			<div id="event-JS.XMLHttpRequest-readyStateChange"></div>/**
			 * @event readyStateChange å½“readyStateå‘ç”Ÿå˜åŒ–
			 * @param {Number} readyState 
			 * @param {Number} status  
			 * @param {JS.XMLHttpRequest} xhr 
			 * @param {XMLHTTPRequest} realXhr å®é™…ä½¿ç”¨çš„XMLHTTPRequestå¯¹è±¡
			 */
			'readyStateChange',
			<div id="event-JS.XMLHttpRequest-timeout"></div>/**
			 * @event timeout è¯·æ±‚è¶…æ—¶
			 * @param {JS.XMLHttpRequest} xhr 
			 * @param {XMLHTTPRequest} realXhr å®é™…ä½¿ç”¨çš„XMLHTTPRequestå¯¹è±¡
			 */
			'timeout',
			<div id="event-JS.XMLHttpRequest-abort"></div>/**
			 * @event abort ä¸»åŠ¨å–æ¶ˆ
			 * @param {JS.XMLHttpRequest} xhr 
			 * @param {XMLHTTPRequest} realXhr å®é™…ä½¿ç”¨çš„XMLHTTPRequestå¯¹è±¡
			 */
			'abort',
			<div id="event-JS.XMLHttpRequest-error"></div>/**
			 * @event error è¯·æ±‚å‡ºé”™
			 * @param {JS.XMLHttpRequest} xhr 
			 * @param {XMLHTTPRequest} realXhr å®é™…ä½¿ç”¨çš„XMLHTTPRequestå¯¹è±¡
			 */
			'error',
			<div id="event-JS.XMLHttpRequest-load"></div>/**
			 * @event load æ¥æ”¶å®Œæ¯•
			 * @param {JS.XMLHttpRequest} xhr 
			 * @param {XMLHTTPRequest} realXhr å®é™…ä½¿ç”¨çš„XMLHTTPRequestå¯¹è±¡
			 */
			'load',
			<div id="event-JS.XMLHttpRequest-progress"></div>/**
			 * @event progress æ­£åœ¨æ¥æ”¶ 
			 * @param {JS.XMLHttpRequest} xhr 
			 * @param {XMLHTTPRequest} realXhr å®é™…ä½¿ç”¨çš„XMLHTTPRequestå¯¹è±¡
			 */
			'progress'
		]);
		JS.XMLHttpRequest.superclass.constructor.apply(this,arguments);
		this._xhr = this.createXmlHttpRequestObject();
		this._xhr.onreadystatechange = function(){
			self.doReadyStateChange();
		};
	},
	//private
	//è¶…æ—¶ä»»åŠ¡
	timeoutTask : null,
	//å»¶è¿Ÿæ‰§è¡Œè¶…æ—¶ä»»åŠ¡(timeoutTask)
	delayTimeout : function(){
		if(this.timeout){
			if(!this.timeoutTask){
				this.timeoutTask = new JS.DelayedTask(function(){
					//readyState=4å·²ç»åœæ­¢ï¼Œç”±doReadyStateChangeæ¥åˆ¤æ–­ä¸ºä½•åœæ­?
					if(this._xhr.readyState != 4){
						this.fireEvent('timeout', this, this._xhr);
					}else{
						this.cancelTimeout();
					}
				},this);
			}
			this.timeoutTask.delay(this.timeout);
		}
	},
	//å–æ¶ˆè¶…æ—¶ä»»åŠ¡
	cancelTimeout : function(){
		if(this.timeoutTask){
			this.timeoutTask.cancel();
		}
	},
	createXmlHttpRequestObject : function(){
		var activeX = [
			'Msxml2.XMLHTTP.6.0', 
			'Msxml2.XMLHTTP.5.0', 
			'Msxml2.XMLHTTP.4.0', 
			'Msxml2.XMLHTTP.3.0', 
			'Msxml2.XMLHTTP', 
			'Microsoft.XMLHTTP'],
		xhr,
		specialXHR = this.specialXHR;
		if(specialXHR){//å¦‚æœæŒ‡å®šäº†xhrå¯¹è±¡
			if(JS.isString(specialXHR)){
				return new ActiveXObject(specialXHR);
			}else{
				return specialXHR;
			}
		}
		try {
			xhr = new XMLHttpRequest();                
		} catch(e) {
			for (var i = 0; i < activeX.length; ++i) {	            
				try {
					xhr = new ActiveXObject(activeX[i]);                        
					break;
				} catch(e) {}
			}
		} finally {
			return xhr;
		}
	},
	//private
	doReadyStateChange : function(){
		this.delayTimeout();
		var xhr = this._xhr;
		try{
			this.readyState = xhr.readyState;
		}catch(e){
			this.readyState = 0;
		}
		try{
			this.status = xhr.status;
		}catch(e){
			this.status = 0;
		}
		try{
			this.statusText = xhr.statusText;
		}catch(e){
			this.statusText = "";
		}
		try {
			this.responseText = xhr.responseText;
		}catch(e){
			this.responseText = "";
		}
		try {
			this.responseXML = xhr.responseXML;
		}catch(e){
			this.responseXML = null;
		}
		
		this.fireEvent('readyStateChange',this.readyState, this.status, this, xhr );
		
		if(this.readyState == 3 && (this.status >= 200 && this.status < 300)){
			this.fireEvent('progress', this, xhr);
		}
		
		if(this.readyState == 4){
			this.cancelTimeout();
			var status = this.status ;
			if(status == 0 || status == ""){
				this.fireEvent('error', this, xhr);
			}else if(status >= 200 && status < 300){
				this.fireEvent('load', this, xhr);
			}else if(status >= 400 && status != 408){
				this.fireEvent('error', this, xhr);
			}else if(status == 408){
				this.fireEvent('timeout', this, xhr);
			}
			
		}
		this.onreadystatechange();
	},
	<div id="method-JS.XMLHttpRequest-onreadystatechange"></div>/**
	 * å…¼å®¹æ ‡å‡†çš„onreadystatechange
	 * @method 
	 */
	onreadystatechange : function(){
	},
	//--------request--------
	<div id="method-JS.XMLHttpRequest-open"></div>/**
	 * å…¼å®¹æ ‡å‡†çš„openæ–¹æ³•
	 * @method 
	 */
	open : function(method, url, async, username, password){
		if(!url){
			return;
		}
		if(!this.enableCache){
			if(url.indexOf('?') != -1){
				url += '&ram='+Math.random();
			}else{
				url += '?ram='+Math.random();
			}
		}
		this._xhr.open(method, url, async, username, password);
	},
	<div id="method-JS.XMLHttpRequest-send"></div>/**
	 * å…¼å®¹æ ‡å‡†çš„sendæ–¹æ³•
	 * @method 
	 */
	send : function(content){
		this.delayTimeout();
		this.isAbort = false;
		this._xhr.send(content);
	},
	<div id="method-JS.XMLHttpRequest-abort"></div>/**
	 * å…¼å®¹æ ‡å‡†çš„abortæ–¹æ³•
	 * @method 
	 */
	abort : function(){
		this.isAbort = true;
		this.cancelTimeout();
		this._xhr.abort();
		if(JS.isIE){//IEåœ¨abortåä¼šæ¸…ç©ºä¾¦å¬
			var self = this;
			self._xhr.onreadystatechange = function(){
				self.doReadyStateChange();
			};
		}
		this.fireEvent('abort',this,this._xhr);
	},
	<div id="method-JS.XMLHttpRequest-setRequestHeader"></div>/**
	 * å…¼å®¹æ ‡å‡†çš„setRequestHeaderæ–¹æ³•
	 * @method 
	 */
	setRequestHeader : function(header, value){
		this._xhr.setRequestHeader(header,value);
	},
	//--------request--------
	<div id="method-JS.XMLHttpRequest-getResponseHeader"></div>/**
	 * å…¼å®¹æ ‡å‡†çš„getResponseHeaderæ–¹æ³•
	 * @method 
	 */
	getResponseHeader : function(header){
		return this._xhr.getResponseHeader(header);
	},
	<div id="method-JS.XMLHttpRequest-getAllResponseHeaders"></div>/**
	 * å…¼å®¹æ ‡å‡†çš„getAllResponseHeadersæ–¹æ³•
	 * @method 
	 */
	getAllResponseHeaders : function(){
		return this._xhr.getAllResponseHeaders();
	},
	<div id="method-JS.XMLHttpRequest-setTimeout"></div>/**
	 * è®¾ç½®å®¢æˆ·ç«¯è¶…æ—¶æ—¶é—?
	 * @method 
	 */
	setTimeout : function(t){
		this.timeout = t;
	}

});</pre>    
</body>
</html>