<html>
<head>
  <title>The source code</title>
    <link href="../resources/prettify/prettify.css" type="text/css" rel="stylesheet" />
    <script type="text/javascript" src="../resources/prettify/prettify.js"></script>
</head>
<body  onload="prettyPrint();">
    <pre class="prettyprint lang-js">/*
 * Comet4J JavaScript Client V0.1.7
 * Copyright(c) 2011, jinghai.xiao@gamil.com.
 * http://code.google.com/p/comet4j/
 * This code is licensed under BSD license. Use it as you wish, 
 * but keep this copyright intact.
 */

<div id="cls-JS.AJAX"></div>/**
 * @class JS.AJAX
 * AJAXå¸¸ç”¨æ–¹æ³•å°è£…
 * @singleton 
 * @author jinghai.xiao@gmail.com
 */
JS.ns("JS.AJAX");

JS.AJAX = (function(){
	var xhr = new JS.XMLHttpRequest();
	return {
		dataFormatError : 'æœåŠ¡å™¨è¿”å›çš„æ•°æ®æ ¼å¼æœ‰è¯¯',
		urlError : 'æœªæŒ‡å®šurl',
		<div id="method-JS.AJAX-post"></div>/**
		 * ä»¥POSTæ–¹å¼å‘æœåŠ¡å™¨å‘é?è¯·æ±‚ï¼Œå¹¶å¾—åˆ°æœåŠ¡è¿”å›çš„xhrå¯¹è±¡ã€?br>
		 * <pre>å¦‚ï¼šJS.Ajax.post('/someurl.do','keyword=xxx',function(xhr){
			alert(xhr.responseText);
		   });</pre>
		 * @method 
		 * @param {String} url ç½‘å€
		 * @param {String|DOM} param å‚æ•°
		 * @param {Function} callback å›è°ƒå‡½æ•° function(xhr){alert(xhr.responseText)}
		 * @param {Object} scope ä½œç”¨åŸ?
		 * @param {Boolean} asyn æ˜¯å¦å¼‚æ­¥è°ƒç”¨ï¼Œé»˜è®¤true
		 */
		post : function(url,param,callback,scope,asyn){
			if(typeof url!=='string'){
				throw new Error(this.urlError);
			}
			//é»˜è®¤ä¸ºå¼‚æ­¥è¯·æ±?
			var asynchronous = true;
			if(asyn===false){
				asynchronous = false;
			}
			xhr.onreadystatechange = function(){
				if(xhr.readyState==4 && asynchronous){
					JS.callBack(callback,scope,[xhr]);
				}
			};
			xhr.open('POST', url, asynchronous);
			xhr.setRequestHeader("Content-Type","application/x-www-form-urlencoded;charset=UTF8");
			xhr.send(param || null);
			if(!asynchronous){
				JS.callBack(callback,scope,[xhr]);
			}
			
		},
		<div id="method-JS.AJAX-get"></div>/**
		 * ä»¥GETæ–¹å¼å‘æœåŠ¡å™¨å‘é?è¯·æ±‚ï¼Œå¹¶å¾—åˆ°æœåŠ¡è¿”å›çš„xhrå¯¹è±¡ã€?br>
		 * <pre>å¦‚ï¼šJS.Ajax.get('/someurl.do','keyword=xxx',function(xhr){
			alert(xhr.responseText);
		   });</pre>
		 * @method 
		 * @param {String} url ç½‘å€
		 * @param {String|DOM} param å‚æ•°
		 * @param {Function} callback å›è°ƒå‡½æ•° function(xhr){alert(xhr.responseText)}
		 * @param {Object} scope ä½œç”¨åŸ?
		 * @param {Boolean} asyn æ˜¯å¦å¼‚æ­¥è°ƒç”¨ï¼Œé»˜è®¤true
		 */
		get : function(url,param,callback,scope,asyn){
			if(typeof url!=='string'){
				throw new Error(this.urlError);
			}
			//é»˜è®¤ä¸ºå¼‚æ­¥è¯·æ±?
			var asynchronous = true;
			if(asyn===false){
				asynchronous = false;
			}
			xhr.onreadystatechange = function(){
				if(xhr.readyState==4 && asynchronous){
					JS.callBack(callback,scope,[xhr]);
				}
			};
			xhr.open('GET', url, asynchronous);
			xhr.setRequestHeader("Content-Type","html/text;charset=UTF8");
			xhr.send(param || null);
			if(!asynchronous){
				JS.callBack(callback,scope,[xhr]);
			}
			
		},
		<div id="method-JS.AJAX-getText"></div>/**
		 * ä»¥GETæ–¹å¼å‘æœåŠ¡å™¨å‘é?è¯·æ±‚ï¼Œå¹¶å¾—åˆ°æœåŠ¡è¿”å›çš„æ–‡æœ¬ä¿¡æ¯ã?<br>
		 * <pre>å¦‚ï¼šJS.Ajax.getText('/someurl.do','keyword=xxx',function(text){
			alert(text);
		   });</pre>
		 * @method 
		 * @param {String} url ç½‘å€
		 * @param {String|DOM} param å‚æ•°
		 * @param {Function} callback å›è°ƒå‡½æ•° function(text){alert(text)}
		 * @param {Object} asyn ä½œç”¨åŸ?
		 * @param {Boolean} asyn æ˜¯å¦å¼‚æ­¥è°ƒç”¨ï¼Œé»˜è®¤true
		 */
		getText : function(url,jsonData,callback,scope,asyn){
			this.get(url,jsonData,function(xhr){
				if(scope){
					callback.call(scope,xhr.responseText);
				}else{
					callback(xhr.responseText);
				}
			},this,asyn);
		},
		<div id="method-JS.AJAX-getJson"></div>/**
		 * ä»¥GETæ–¹å¼å‘æœåŠ¡å™¨å‘é?è¯·æ±‚ï¼Œå¹¶å¾—åˆ°æœåŠ¡è¿”å›çš„JSONå¯¹è±¡ã€?br>
		 * <pre>å¦‚ï¼šJS.Ajax.getJson('/someurl.do','keyword=xxx',function(obj){
			alert(obj.someField);
		   });</pre>
		 * @method 
		 * @param {String} url ç½‘å€
		 * @param {String|DOM} param å‚æ•°
		 * @param {Function} callback å›è°ƒå‡½æ•° function(obj){alert(alert(obj.someField);)}
		 * @param {Object} scope ä½œç”¨åŸ?
		 * @param {Boolean} asyn æ˜¯å¦å¼‚æ­¥è°ƒç”¨ï¼Œé»˜è®¤true
		 */
		getJson : function(url,jsonData,callback,scope,asyn){
			this.get(url,jsonData,function(xhr){
				var json = null;
				try{
					json = eval("("+xhr.responseText+")");
				}catch(e){
					throw new Error(this.dataFormatError);
				}
				JS.callBack(callback,scope,[json]);
			},this,asyn);
		}
	};
})();</pre>    
</body>
</html>