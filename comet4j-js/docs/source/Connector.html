<html>
<head>
  <title>The source code</title>
    <link href="../resources/prettify/prettify.css" type="text/css" rel="stylesheet" />
    <script type="text/javascript" src="../resources/prettify/prettify.js"></script>
</head>
<body  onload="prettyPrint();">
    <pre class="prettyprint lang-js">/*
 * Comet4J JavaScript Client V0.1.7
 * Copyright(c) 2011, jinghai.xiao@gamil.com.
 * http://code.google.com/p/comet4j/
 * This code is licensed under BSD license. Use it as you wish, 
 * but keep this copyright intact.
 */

<div id="cls-JS.Connector"></div>/**
 * @class JS.Connector
 * @extends JS.Observable
 * è¿æ¥å™?è´Ÿè´£å»ºç«‹å¹¶ç»´æŒè¿æ¥ï¼Œæ¥æ”¶æœåŠ¡å™¨ç«¯æ¨é?çš„æ•°æ®ã?
 * @author jinghai.xiao@gmail.com
 */
JS.ns("JS.Connector");
JS.Connector = JS.extend(JS.Observable,{
   <div id="prop-JS.Connector-version"></div>/** 
    * ç‰ˆæœ¬
    * @property 
    * @type String
    */ 
	version : JS.version,
	SYSCHANNEL:'c4j', //åè®®å¸¸é‡
	<div id="prop-JS.Connector-LLOOPSTYLE"></div>/** 
	 * é•¿è½®è¯¢å·¥ä½œæ¨¡å¼å¸¸é‡?
	 * @property 
	 * @type String
	 */ 
	LLOOPSTYLE : 'lpool',//åè®®å¸¸é‡
	<div id="prop-JS.Connector-STREAMSTYLE"></div>/** 
	 * é•¿è¿æ¥å·¥ä½œæ¨¡å¼å¸¸é‡?
	 * @property 
	 * @type String
	 */ 
	STREAMSTYLE : 'stream',//åè®®å¸¸é‡
	CMDTAG : 'cmd',
	<div id="cfg-JS.Connector-retryCount"></div>/**
	 * @cfg {String} retryCount 
	 * é‡è¯•æ¬¡æ•°ï¼Œè¿ç»­é‡è¯•æŒ‡å®šæ¬¡æ•°ä»æ— æ³•æ­£å¸¸å·¥ä½œåˆ™stop.
	 */
	retryCount : 3,
	<div id="cfg-JS.Connector-retryCount"></div>/**
	 * @cfg {String} retryCount 
	 * é‡è¯•å»¶è¿Ÿï¼Œé‡è¯•æ—¶é—´éš”æŒ‡å®šæ—¶é—´æ‰§è¡Œ
	 */
	retryDelay : 1000,
	currRetry : 0,
	<div id="cfg-JS.Connector-url"></div>/**
	 * @cfg {String} url 
	 * è¿æ¥åœ°å€ï¼Œè‹¥ä½¿ç”¨startæ–¹æ³•ä¸­å¸¦æœ‰urlï¼Œåˆ™æ­¤é…ç½®é¡¹å°†è¢«è¦†ç›–ã€?
	 */
	url : '',
	<div id="cfg-JS.Connector-param"></div>/**
	 * @cfg {Object} param 
	 * è¿æ¥å‚æ•°ï¼Œè‹¥ä½¿ç”¨startæ–¹æ³•ä¸­å¸¦æœ‰paramï¼Œåˆ™æ­¤é…ç½®é¡¹å°†è¢«è¦†ç›–ã€?
	 */
	param : '',
	<div id="cfg-JS.Connector-revivalDelay"></div>/**
	 * @cfg {Object} revivalDelay
	 * å¤æ´»è¯·æ±‚å»¶æ—¶æ¯«ç§’æ•?é»˜è®¤ä¸?00
	 */
	revivalDelay : 100,
    <div id="prop-JS.Connector-cId"></div>/** 
	 * è¿æ¥IDï¼Œè¿æ¥åæœ‰æ•ˆ
	 * @property 
	 * @type String
	 */ 
	cId : '',
	<div id="prop-JS.Connector-channels"></div>/** 
	 * é€šé“åˆ—è¡¨ï¼Œè¿æ¥åæœ‰æ•ˆ
	 * @property 
	 * @type Array
	 */ 
	channels : [],
	<div id="prop-JS.Connector-workStyle"></div>/** 
	 * è¿æ¥å·¥ä½œæ¨¡å¼ï¼Œè¿æ¥åæœ‰æ•ˆã€‚å?ä¸ºï¼šLLOOPSTYLEæˆ–STREAMSTYLE
	 * @property 
	 * @type String
	 */ 
	workStyle : '',
	emptyUrlError : 'URLä¸ºç©º',
	runningError : 'è¿æ¥æ­£åœ¨è¿è¡Œ',
	dataFormatError : 'æ•°æ®æ ¼å¼æœ‰è¯¯',
	<div id="prop-JS.Connector-running"></div>/** 
	 * è¿æ¥å™¨æ˜¯å¦å¤„äºè¿è¡ŒçŠ¶æ€?
	 * @property 
	 * @type String
	 */ 
	running : false,
	_xhr : null,
	lastReceiveMessage : '',
	constructor:function(){
		JS.Connector.superclass.constructor.apply(this,arguments);
		this.addEvents([
			<div id="event-JS.Connector-beforeConnect"></div>/**
			 * @event beforeConnect å³å°†è¿æ¥
			 * @param {String} url è¿æ¥åœ°å€
			 * @param {Connector} conn è¿æ¥å™?
			 */
			'beforeConnect',
			<div id="event-JS.Connector-connect"></div>/**
			 * @event connect å·²è¿æ?
			 * @param {String} cId è¿æ¥ID
			 * @param {Array} channels é€šé“åˆ—è¡¨
			 * @param {String} workStyle å·¥ä½œæ¨¡å¼
			 * @param {Number} timeout è¿æ¥è¶…æ—¶æ—¶é—´
			 * @param {Connector} conn è¿æ¥å™?
			 */
			'connect',
			<div id="event-JS.Connector-beforeStop"></div>/**
			 * @event beforeStop å³å°†åœæ­¢
			 * @param {String} cause åœæ­¢åŸå› 
			 * @param {String} cId è¿æ¥ID
			 * @param {String} url è¿æ¥åœ°å€
			 * @param {Connector} conn è¿æ¥å™?
			 */
			'beforeStop',
			<div id="event-JS.Connector-stop"></div>/**
			 * @event stop å·²åœæ­?
			 * @param {String} cause åœæ­¢åŸå› 
			 * @param {String} cId è¿æ¥ID
			 * @param {String} url è¿æ¥åœ°å€
			 * @param {Connector} conn è¿æ¥å™?
			 */
			'stop',
			<div id="event-JS.Connector-message"></div>/**
			 * @event message æ¥æ”¶åˆ°æ¨é€æ•°æ?
			 * @param {String} channel é€šé“æ ‡è¯†
			 * @param {Object} data æ•°æ®å¯¹è±¡
			 * @param {Number} time å‘é?æ—¶é—´ï¼Œè·1970-01-01 00:00:00æ¯«ç§’æ•?
			 * @param {Connector} conn è¿æ¥å™?
			 */
			'message',
			<div id="event-JS.Connector-revival"></div>/**
			 * @event revival è¯·æ±‚å¤æ´»ï¼Œç”¨äºä¿æŒè¿æ¥ã?
			 * @param {String} url è¿æ¥åœ°å€
			 * @param {String} cId è¿æ¥ID
			 * @param {Connector} conn è¿æ¥å™?
			 */
			'revival'
		]);
		if(JS.isIE7){
			this._xhr = new JS.XMLHttpRequest({
				specialXHR : 'Msxml2.XMLHTTP.6.0'
			});
		}else{
			this._xhr = new JS.XMLHttpRequest();
		}
		//this._xhr.addListener('readyStateChange',this.onReadyStateChange,this);
		
		this._xhr.addListener('progress',this.doOnProgress,this);
		this._xhr.addListener('load',this.doOnLoad,this);
		this._xhr.addListener('error',this.doOnError,this);
		this._xhr.addListener('timeout',this.doOnTimeout,this);
		
		this.addListener('beforeStop',this.doDrop,this);
		JS.on(window,'beforeunload',this.doDrop,this);

	},
	//private
	doDrop : function(url,cId,conn,xhr){
		if(!this.running || !this.cId){
			return;
		}
		try {
			var xhr = new JS.XMLHttpRequest();
			var param = this.perfectParam(this.param);
			var url = this.url + '?'+this.CMDTAG+'=drop&cid=' + this.cId + param;
			xhr.open('GET', url, false);
			xhr.send(null);
			xhr = null;
		}catch(e){};
	},
	//private distributed æ´¾å‘æœåŠ¡å™¨æ¶ˆæ?
	dispatchServerEvent : function(msg){
		this.fireEvent('message', msg.channel, msg.data, msg.time, this);
	},
	//private é•¿è¿æ¥ä¿¡æ¯è½¬æ?
	translateStreamData : function(responseText){
		var str = responseText;
		if(this.lastReceiveMessage && str){//å‰¥ç¦»å‡ºæ¥æ”¶åˆ°çš„æ•°æ?
			str = str.split(this.lastReceiveMessage);
			str = str.length ? str[str.length-1] : "";
		}
		this.lastReceiveMessage = responseText;
		return str;
	},
	//private æ¶ˆæ¯è§£ç 
	decodeMessage : function(msg){
		var json = null;
		if(JS.isString(msg) && msg!=""){
			//è§£ææ•°æ®æ ¼å¼
			if(msg.charAt(0)=="<" ){
				msg = msg.substring(1,msg.length);
			}
			if(msg.charAt(msg.length-1)==">"){
				msg = msg.substring(0,msg.length-1);
			}
			msg = decodeURIComponent(msg);
			try{
				json = eval("("+msg+")");
			}catch(e){
				this.stop('JSONè½¬æ¢å¼‚å¸¸');
			}			
		}
		return json;
	},
	//private
	doOnProgress : function(xhr){
		if(this.workStyle === this.STREAMSTYLE){				
			var str = this.translateStreamData(xhr.responseText);
			var msglist = str.split(">");
			if(msglist.length > 0){
				for(var i=0, len=msglist.length; i<len; i++){
					if(!msglist[i] && i!=0){
						return;
					}
					var json = this.decodeMessage(msglist[i]);
					if(json){
						this.currRetry = 0;
						this.dispatchServerEvent(json);
						if(json.channel == this.SYSCHANNEL){
							this.revivalConnect();
						}
					}else{//éæ­£å¸¸æƒ…å†µï¼ŒçŠ¶æ?ä¸?,200å¹¶ä¸”è¿˜æ²¡æœ‰æ”¶åˆ°ä»»ä½•æ•°æ?
						this.currRetry++;
						if(this.currRetry > this.retryCount){
							this.stop('æœåŠ¡å™¨å¼‚å¸?);
						}else{
							this.retryRevivalConnect();
						}
					}
				}
			}
		}
	},
	//private
	doOnLoad : function(xhr){
		if(this.workStyle === this.LLOOPSTYLE){
			var json = this.decodeMessage(xhr.responseText);
			if(json){
				this.currRetry = 0;
				this.dispatchServerEvent(json);
				this.revivalConnect();
			}else{//éæ­£å¸¸æƒ…å†µï¼ŒçŠ¶æ?ä¸?,200å¹¶ä¸”è¿˜æ²¡æœ‰æ”¶åˆ°ä»»ä½•æ•°æ?
				this.currRetry++;
				if(this.currRetry > this.retryCount){
					this.stop('æœåŠ¡å™¨å¼‚å¸?);
				}else{
					this.retryRevivalConnect();
				}
			}
		}
	},
	//private
	doOnError : function(xhr){
		this.currRetry++;
		if(this.currRetry > this.retryCount){
			this.stop('æœåŠ¡å™¨å¼‚å¸?);
		}else{
			this.retryRevivalConnect();
		}
		
	},
	//private
	doOnTimeout : function(xhr){
		this.currRetry++;
		if(this.currRetry > this.retryCount){
			this.stop('è¯·æ±‚è¶…æ—¶');
		}else{
			this.retryRevivalConnect();
		}
	},
	//private
	startConnect : function(url){
		if(this.running){
			var connXhr = new JS.XMLHttpRequest();
			connXhr.addListener('error',function(xhr){
				this.stop("è¿æ¥æ—¶å‘ç”Ÿé”™è¯?);
			},this);
			connXhr.addListener('timeout',function(xhr){
				this.stop("è¿æ¥è¶…æ—¶");
			},this);
			connXhr.addListener('load',function(xhr){
				var msg = this.decodeMessage(xhr.responseText);
				if(!msg){
					this.stop('è¿æ¥å¤±è´¥');
					return;
				}
				var data = msg.data;
				this.cId = data.cId;
				this.channels = data.channels;
				this.workStyle = data.ws;
				this._xhr.setTimeout(data.timeout + 1000/*ç½‘ç»œå»¶è¿Ÿè¯¯å·®*/);
				this.fireEvent('connect', data.cId, data.channels, data.ws, data.timeout, this);
				this.revivalConnect();
			},this);
			connXhr.open('GET', url, true);
			connXhr.send(null);
			/*
			JS.AJAX.get(url,'',function(xhr){
				var msg = this.decodeMessage(xhr.responseText);
				if(!msg){
					this.stop('è¿æ¥å¤±è´¥');
					return;
				}
				var data = msg.data;
				this.cId = data.cId;
				this.channels = data.channels;
				this.workStyle = data.ws;
				this._xhr.setTimeout(data.timeout + 1000);
				this.fireEvent('connect', data.cId, data.channels, data.ws, data.timeout, this);
				this.revivalConnect();
			},this);*/
		}
	},

	//private é‡è¯•å¤æ´»è¿æ¥
	retryRevivalConnect : function(){
		var self = this;
		if(this.running){
			setTimeout(function(){
				self.revivalConnect();
			},this.retryDelay);
		}
	},
	
	//private
	revivalConnect : function(){
		var self = this;
		if(this.running){
			setTimeout(revival,this.revivalDelay);
		}
		function revival(){
			var xhr = self._xhr;
			var param = self.perfectParam(self.param);
			var url = self.url + '?'+self.CMDTAG+'=revival&cid=' + self.cId + param;
			xhr.open('GET', url, true);
			xhr.send(null);
			self.fireEvent('revival',self.url, self.cId, self);
		}
		
	},
	<div id="method-JS.Connector-start"></div>/**
	 * å¼?§‹è¿æ¥
	 * @method 
	 * @param {String} url è¿æ¥åœ°å€
	 * @param {String|DOM} param è¿æ¥å‚æ•°
	 */
	start : function(url,param){
		if(this.running){
			return;
		}
		
		this.url = url || this.url;
		if(!this.url){
			throw new Error(this.emptyUrlError);
		}
		
		if(this.fireEvent('beforeConnect', this.url, this) === false){
			return;
		}
		
		this.param = param || this.param;
		param = this.perfectParam(this.param);
		var url = this.url+'?'+this.CMDTAG+'=conn&cv='+this.version+param;
		
		this.running = true;
		this.currRetry = 0;
		var self = this;
		setTimeout(function(){
			self.startConnect(url);
		},1000);
	},
	// å®Œå–„å‚æ•°
	perfectParam : function(param){
		if(param && JS.isString(param)){
			if(param.charAt(0) != '&'){
				param = '&'+param;
			}
		}
		return param;
	},
	<div id="method-JS.Connector-stop"></div>/**
	 * åœæ­¢è¿æ¥
	 * @method 
	 * @param {String} cause åœæ­¢åŸå› 
	 */
	stop : function(cause){
		if(!this.running){
			return;
		}
		if(this.fireEvent('beforeStop',cause,this.cId, this.url,  this) === false){
			return;
		}
		this.running = false;
		var cId = this.cId;
		this.cId = '';
		this.channels = [];
		this.workStyle = '';
		try{
			this._xhr.abort();
		}catch(e){};
		this.fireEvent('stop',cause, cId, this.url, this);
	},
	<div id="method-JS.Connector-getId"></div>/**
	 * è·å¾—è¿æ¥ID
	 * @method 
	 * @return {String} è¿æ¥ID
	 */
	getId : function(){
		return this.cId;
	}
});</pre>    
</body>
</html>